package main

import (
	"fmt"
	"log"
	"os"

	"github.com/joho/godotenv"
	"github.com/wei979/ICACP/backend/internal/models"
	"gorm.io/driver/mysql"
	"gorm.io/gorm"
)

// SchoolSeed represents a school seed data
type SchoolSeed struct {
	Name       string
	CountyName string
	Address    string
	Phone      string
}

func main() {
	// Load .env file
	if err := godotenv.Load(); err != nil {
		log.Println("No .env file found, using environment variables")
	}

	// Get database URL
	dsn := os.Getenv("DATABASE_URL")
	if dsn == "" {
		log.Fatal("DATABASE_URL is not set")
	}

	// Connect to database
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
	if err != nil {
		log.Fatalf("Failed to connect to database: %v", err)
	}

	fmt.Println("Connected to database successfully")

	// Define seed data for South Taiwan schools
	schools := []SchoolSeed{
		// ================================================
		// 高雄市學校（原住民重點學校）
		// ================================================
		// 那瑪夏區
		{"那瑪夏國民中學", "高雄市", "高雄市那瑪夏區達卡努瓦里大光巷181號", "07-6701715"},
		{"民權國民小學", "高雄市", "高雄市那瑪夏區瑪雅里平和巷220號", "07-6701200"},
		{"民生國民小學", "高雄市", "高雄市那瑪夏區達卡努瓦里秀嶺巷180號", "07-6701701"},
		// 桃源區
		{"桃源國民中學", "高雄市", "高雄市桃源區桃源里北進巷8號", "07-6861014"},
		{"桃源國民小學", "高雄市", "高雄市桃源區桃源里北進巷10號", "07-6861012"},
		{"寶山國民小學", "高雄市", "高雄市桃源區寶山里寶山巷16號", "07-6891012"},
		{"建山國民小學", "高雄市", "高雄市桃源區建山里建山巷17號", "07-6871014"},
		{"興中國民小學", "高雄市", "高雄市桃源區高中里興中巷31號", "07-6891268"},
		// 茂林區
		{"茂林國民中學", "高雄市", "高雄市茂林區茂林里1號", "07-6801040"},
		{"茂林國民小學", "高雄市", "高雄市茂林區茂林里100號", "07-6801045"},
		{"多納國民小學", "高雄市", "高雄市茂林區多納里1號", "07-6801178"},
		// 甲仙區
		{"甲仙國民中學", "高雄市", "高雄市甲仙區西安里文化路45號", "07-6751073"},
		{"甲仙國民小學", "高雄市", "高雄市甲仙區西安里文化路65號", "07-6751024"},
		{"小林國民小學", "高雄市", "高雄市甲仙區小林里五里路50號", "07-6761440"},

		// ================================================
		// 屏東縣學校（原住民重點學校）
		// ================================================
		// 三地門鄉
		{"三地國民中學", "屏東縣", "屏東縣三地門鄉三地村中正路二段110號", "08-7991096"},
		{"三地國民小學", "屏東縣", "屏東縣三地門鄉三地村行政街6號", "08-7991064"},
		{"賽嘉國民小學", "屏東縣", "屏東縣三地門鄉賽嘉村賽嘉巷60號", "08-7992094"},
		{"德文國民小學", "屏東縣", "屏東縣三地門鄉德文村德文巷39號", "08-7967036"},
		{"青葉國民小學", "屏東縣", "屏東縣三地門鄉青葉村光復巷1號", "08-7962114"},
		// 霧臺鄉
		{"霧臺國民小學", "屏東縣", "屏東縣霧臺鄉霧臺村中山巷39號", "08-7902234"},
		// 瑪家鄉
		{"瑪家國民中學", "屏東縣", "屏東縣瑪家鄉北葉村風景104號", "08-7991748"},
		{"北葉國民小學", "屏東縣", "屏東縣瑪家鄉北葉村風景巷1之2號", "08-7991639"},
		{"長榮百合國民小學", "屏東縣", "屏東縣瑪家鄉瑪家村和平路一段65號", "08-7997520"},
		// 泰武鄉
		{"泰武國民中學", "屏東縣", "屏東縣泰武鄉佳平村15號", "08-7920149"},
		{"泰武國民小學", "屏東縣", "屏東縣泰武鄉泰武村阿夫魯岸路1號", "08-7920227"},
		{"萬安國民小學", "屏東縣", "屏東縣泰武鄉萬安村2鄰20號", "08-7920147"},
		// 來義鄉
		{"來義高級中學", "屏東縣", "屏東縣來義鄉古樓村中正路147號", "08-7850086"},
		{"望嘉國民小學", "屏東縣", "屏東縣來義鄉望嘉村望嘉路1號", "08-8791014"},
		{"文樂國民小學", "屏東縣", "屏東縣來義鄉文樂村8號", "08-8791036"},
		// 春日鄉
		{"春日國民中學", "屏東縣", "屏東縣春日鄉春日村春日路322號", "08-8782028"},
		{"春日國民小學", "屏東縣", "屏東縣春日鄉春日村1鄰春日路170號", "08-8782006"},
		{"力里國民小學", "屏東縣", "屏東縣春日鄉七佳村自強路76號", "08-8791006"},
		// 獅子鄉
		{"獅子國民中學", "屏東縣", "屏東縣獅子鄉獅子村15-1號", "08-8771029"},
		{"丹路國民小學", "屏東縣", "屏東縣獅子鄉丹路村1號", "08-8771414"},
		{"楓林國民小學", "屏東縣", "屏東縣獅子鄉楓林村楓林路1號", "08-8771034"},
		// 牡丹鄉
		{"牡丹國民中學", "屏東縣", "屏東縣牡丹鄉石門村石門路31號", "08-8831046"},
		{"牡丹國民小學", "屏東縣", "屏東縣牡丹鄉牡丹村牡丹路51號", "08-8831164"},
		{"高士國民小學", "屏東縣", "屏東縣牡丹鄉高士村高士路40號", "08-8810140"},
		// 滿州鄉
		{"滿州國民中學", "屏東縣", "屏東縣滿州鄉滿州村中山路43號", "08-8801078"},
		{"滿州國民小學", "屏東縣", "屏東縣滿州鄉滿州村中山路52號", "08-8801074"},

		// ================================================
		// 臺南市學校
		// ================================================
		{"南化國民中學", "臺南市", "臺南市南化區南化里17號", "06-5771010"},
		{"南化國民小學", "臺南市", "臺南市南化區南化里230號", "06-5771034"},
		{"瑞峰國民小學", "臺南市", "臺南市南化區關山里98號", "06-5771487"},
		{"玉山國民小學", "臺南市", "臺南市南化區玉山里17號", "06-5772430"},
		{"楠西國民中學", "臺南市", "臺南市楠西區楠西里中正路326號", "06-5751005"},
		{"楠西國民小學", "臺南市", "臺南市楠西區楠西里民生路1號", "06-5751131"},
		{"白河國民中學", "臺南市", "臺南市白河區昇安里三民路448號", "06-6852067"},
		{"白河國民小學", "臺南市", "臺南市白河區白河里三民路396號", "06-6852177"},

		// ================================================
		// 嘉義縣學校（含原住民地區）
		// ================================================
		// 阿里山鄉
		{"阿里山國民中小學", "嘉義縣", "嘉義縣阿里山鄉中正村59號", "05-2679184"},
		{"達邦國民小學", "嘉義縣", "嘉義縣阿里山鄉達邦村1鄰17號", "05-2511234"},
		{"十字國民小學", "嘉義縣", "嘉義縣阿里山鄉十字村3鄰51號", "05-2561092"},
		{"新美國民小學", "嘉義縣", "嘉義縣阿里山鄉新美村2鄰35號", "05-2513544"},
		{"山美國民小學", "嘉義縣", "嘉義縣阿里山鄉山美村4鄰59號", "05-2586520"},
		{"來吉國民小學", "嘉義縣", "嘉義縣阿里山鄉來吉村4鄰117號", "05-2661231"},
		{"豐山實驗教育學校", "嘉義縣", "嘉義縣阿里山鄉豐山村50號", "05-2661046"},
		{"茶山國民小學", "嘉義縣", "嘉義縣阿里山鄉茶山村60號", "05-2513040"},
		// 番路鄉
		{"民和國民中學", "嘉義縣", "嘉義縣番路鄉民和村菜公店118號", "05-2591074"},
		{"民和國民小學", "嘉義縣", "嘉義縣番路鄉民和村菜公店117號", "05-2591543"},
		// 竹崎鄉
		{"竹崎高級中學", "嘉義縣", "嘉義縣竹崎鄉竹崎村中山路1號", "05-2611006"},
		{"竹崎國民小學", "嘉義縣", "嘉義縣竹崎鄉竹崎村文化路18號", "05-2611006"},

		// ================================================
		// 嘉義市學校
		// ================================================
		{"北興國民中學", "嘉義市", "嘉義市東區後湖里博東路262號", "05-2766455"},
		{"北園國民小學", "嘉義市", "嘉義市西區北湖里北社尾路168號", "05-2338054"},
		{"興安國民小學", "嘉義市", "嘉義市東區興安里重慶路608號", "05-2783083"},
		{"嘉義國民小學", "嘉義市", "嘉義市東區芳草里公明路166號", "05-2222113"},
	}

	// Insert schools
	var created, skipped int
	for _, seed := range schools {
		// Check if school already exists
		var count int64
		db.Model(&models.School{}).Where("name = ? AND county_name = ?", seed.Name, seed.CountyName).Count(&count)
		if count > 0 {
			fmt.Printf("Skipped (already exists): %s\n", seed.Name)
			skipped++
			continue
		}

		school := models.School{
			Name:       seed.Name,
			CountyName: seed.CountyName,
			Address:    seed.Address,
			Phone:      seed.Phone,
		}

		if err := db.Create(&school).Error; err != nil {
			log.Printf("Failed to create school %s: %v\n", seed.Name, err)
			continue
		}

		fmt.Printf("Created: %s (%s)\n", seed.Name, seed.CountyName)
		created++
	}

	fmt.Printf("\n========================================\n")
	fmt.Printf("Seed completed: %d created, %d skipped\n", created, skipped)

	// Print summary by county
	fmt.Printf("\n========================================\n")
	fmt.Println("Summary by county:")
	var results []struct {
		CountyName  string
		SchoolCount int
	}
	db.Model(&models.School{}).
		Select("county_name, COUNT(*) as school_count").
		Group("county_name").
		Order("school_count DESC").
		Scan(&results)

	for _, r := range results {
		fmt.Printf("  %s: %d schools\n", r.CountyName, r.SchoolCount)
	}
}
