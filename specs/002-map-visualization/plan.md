# Implementation Plan: Taiwan Map Visualization

**Branch**: `002-map-visualization` | **Date**: 2025-11-14 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-map-visualization/spec.md`

**Note**: This document was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

**Primary Requirement**: Develop an interactive Taiwan map visualization that displays data coverage by county/city using color coding (green = has data, gray = no data). Users can click counties to view basic statistics (school count, student count). The map supports zoom, pan, and reset operations.

**Technical Approach**:
- **Frontend**: Leaflet.js 1.9+ for interactive map rendering with GeoJSON Taiwan boundaries
- **Backend**: Go + Gin RESTful API for county statistics aggregation
- **Database**: MySQL read-only queries (no new tables; aggregates existing schools/students data)
- **Caching**: Redis 15-minute TTL to reduce database load by 80%
- **Authentication**: Integrate with existing JWT middleware from 001-user-auth feature

**MVP Scope**: Desktop-only, manual refresh, no animations or real-time updates.

## Technical Context

**Language/Version**:
- Backend: Go 1.21+
- Frontend: TypeScript 5.0+ with Next.js 14 (Pages Router)

**Primary Dependencies**:
- Backend: Gin 1.9+, GORM 1.25+, go-redis/redis/v8 8.11+
- Frontend: Leaflet 1.9+, react-leaflet 4.2+, @tanstack/react-query 5.28+, Axios 1.6+

**Storage**:
- MySQL 8.0+ (AWS RDS t3.micro): Read-only access to existing `schools` and `students` tables
- Redis (AWS ElastiCache cache.t3.micro): 15-minute TTL cache for county statistics

**Testing**:
- Backend: Go testing framework with table-driven tests for service layer
- Frontend: Manual testing per quickstart.md (automated testing optional for MVP)
- Contract Testing: OpenAPI spec validation (contracts/map-api.yaml)

**Target Platform**:
- Frontend: Modern desktop browsers (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)
- Backend: Linux server (AWS EC2 t3.micro)
- Minimum Screen Resolution: 1024x768 (desktop-only)

**Project Type**: Web application (separate backend + frontend)

**Performance Goals**:
- Map initial load: <3 seconds on standard connection
- County statistics API response: <1 second per request
- Redis cache hit ratio: ≥80% after warm-up
- Concurrent users: 20 users (MVP target)

**Constraints**:
- Desktop-only (no mobile browser support in MVP)
- Manual page refresh for data updates (no auto-refresh or WebSocket)
- No animations or complex map layers (simple MVP)
- Authentication required for all map access

**Scale/Scope**:
- 22 Taiwan counties/cities to display
- Expected MVP data: <100 schools across ~5-10 counties
- Expected MVP users: <20 concurrent users
- 2 API endpoints (all counties, single county)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Security First (NON-NEGOTIABLE)
- [x] **Authentication**: All API endpoints protected by JWT middleware (reused from 001-user-auth)
- [x] **Input Validation**: County name validated against 22-county whitelist
- [x] **SQL Injection Prevention**: GORM parameterized queries (no string concatenation)
- [x] **Data Protection**: County-level aggregation only (no individual student data exposed)

### ✅ API-First Design
- [x] **RESTful Endpoints**: `GET /api/v1/counties/statistics`, `GET /api/v1/counties/{name}/statistics`
- [x] **API Versioning**: All endpoints prefixed with `/api/v1`
- [x] **OpenAPI Spec**: Documented in contracts/map-api.yaml
- [x] **Consistent Response Format**: `{data: {...}}` for success, `{error: {...}}` for errors

### ✅ Type Safety & Validation
- [x] **Backend**: Go structs with GORM tags for CountyStatistics model
- [x] **Frontend**: TypeScript interfaces for CountyStatistics and AllCountyStatistics
- [x] **API Contract**: Zod schemas for runtime validation (frontend)
- [x] **Database**: Existing NOT NULL constraints on schools.county_name

### ✅ Code Quality & Maintainability
- [x] **Single Responsibility**: Separate service, handler, and route layers (backend)
- [x] **Component Separation**: MapView, CountyPopup, MapControls (frontend)
- [x] **Dependency Injection**: Database and Redis clients passed to service constructors
- [x] **No Over-Engineering**: Simple aggregation queries, no repository pattern (unnecessary complexity)

### ✅ Technology Stack Compliance
- [x] **Backend**: Go 1.21+ with Gin framework (constitution mandated)
- [x] **Frontend**: Next.js 14 Pages Router with TypeScript (constitution mandated)
- [x] **State Management**: React Query + Context API (constitution mandated, NO Redux/MobX)
- [x] **Map Library**: Leaflet.js 1.9+ (lightweight, no API key required)
- [x] **Database**: MySQL 8.0+ on AWS RDS (constitution mandated)
- [x] **Cache**: Redis on AWS ElastiCache (constitution mandated)

### ✅ Performance Requirements
- [x] **Caching Strategy**: Redis 15-minute TTL for county statistics (target: 80% cache hit ratio)
- [x] **Query Optimization**: Index on `schools.county_name` for fast aggregation
- [x] **Response Time**: <1 second for county statistics API (constitution target)
- [x] **Initial Load**: <3 seconds for map page (constitution target)

### ✅ Simplicity Principles
- [x] **No New Tables**: Read-only feature using existing schools/students tables
- [x] **No Complex Patterns**: Direct service layer, no repository abstraction
- [x] **Static Assets**: GeoJSON served as frontend public file (no database storage)
- [x] **Minimal Dependencies**: Only 2 new frontend packages (leaflet, react-leaflet), 1 new backend package (go-redis)

**Constitution Compliance**: ✅ PASSED (no violations)

## Project Structure

### Documentation (this feature)

```text
specs/002-map-visualization/
├── plan.md              # This file (/speckit.plan command output)
├── spec.md              # Feature specification (/speckit.specify command output)
├── research.md          # Phase 0 technology research and decisions
├── data-model.md        # Phase 1 database schema and query patterns
├── quickstart.md        # Phase 1 implementation guide with code examples
├── contracts/
│   └── map-api.yaml     # Phase 1 OpenAPI 3.0 specification
└── checklists/
    └── requirements.md  # Specification quality validation (completed)
```

### Source Code (repository root)

```text
backend/
├── cmd/
│   └── server/
│       └── main.go              # Application entry point with route registration
├── internal/
│   ├── models/
│   │   └── county.go            # CountyStatistics struct (GORM model)
│   ├── services/
│   │   └── county_service.go    # Business logic: aggregation queries + Redis caching
│   ├── handlers/
│   │   └── county_handler.go    # HTTP handlers for county statistics endpoints
│   └── middleware/
│       └── auth.go              # JWT authentication (reused from 001-user-auth)
├── config/
│   └── redis.go                 # Redis client initialization
├── go.mod                       # Go module dependencies
├── go.sum                       # Dependency checksums
└── .env                         # Environment variables (DATABASE_URL, REDIS_URL, JWT_SECRET)

frontend/
├── src/
│   ├── pages/
│   │   ├── map.tsx              # Main map page (protected route)
│   │   └── _app.tsx             # Next.js app wrapper (existing from 001-user-auth)
│   ├── components/
│   │   ├── auth/
│   │   │   └── ProtectedRoute.tsx  # Authentication wrapper (reused from 001-user-auth)
│   │   └── map/
│   │       ├── MapView.tsx      # Leaflet map container component
│   │       ├── CountyLayer.tsx  # GeoJSON layer with color styling
│   │       ├── CountyPopup.tsx  # Statistics popup component
│   │       └── MapControls.tsx  # Zoom/reset control buttons
│   ├── hooks/
│   │   ├── useCountyStats.ts    # React Query hook for fetching county statistics
│   │   └── useMapState.ts       # Context API hook for map UI state (zoom, selected county)
│   ├── lib/
│   │   ├── api.ts               # Axios instance with auth interceptors (existing from 001-user-auth)
│   │   └── leaflet-utils.ts     # Leaflet initialization and helper functions
│   ├── types/
│   │   └── county.ts            # TypeScript interfaces for CountyStatistics
│   └── data/
│       └── taiwan-counties.geojson  # Static GeoJSON file with Taiwan county boundaries
├── public/
│   └── data/
│       └── taiwan-counties.geojson  # Alternative location (referenced in quickstart.md)
├── package.json                 # NPM dependencies (leaflet, react-leaflet added)
├── tsconfig.json                # TypeScript configuration
├── next.config.js               # Next.js configuration
└── .env.local                   # Frontend environment variables (NEXT_PUBLIC_API_URL)

tests/
└── integration/
    └── map/
        └── county_api_test.go   # Integration tests for county statistics endpoints (optional for MVP)
```

**Structure Decision**: Web application structure (Option 2) with clear separation of backend and frontend. Backend follows layered architecture (handlers → services → models). Frontend uses Next.js Pages Router with component-based structure. This aligns with constitution requirements and 001-user-auth foundation.

## Phase 0: Technology Research

**Status**: ✅ COMPLETED

**Output**: [research.md](./research.md)

**Key Decisions Documented**:
1. **Map Library**: Leaflet.js 1.9+ chosen for simplicity, no API key requirement, and excellent GeoJSON support
2. **Taiwan Boundaries**: GeoJSON format from Taiwan Open Data Platform (22 counties/cities)
3. **Backend API**: Go + Gin RESTful endpoints with GORM for aggregation queries
4. **Caching**: Redis with 15-minute TTL to achieve 80% cache hit ratio
5. **State Management**: React Query for server state, Context API for map UI state
6. **Component Structure**: Separate MapView, CountyPopup, CountyLayer, MapControls components
7. **Authentication**: Reuse JWT middleware from 001-user-auth feature

**Alternatives Considered and Rejected**:
- Google Maps API: Requires API key and billing; overkill for MVP
- Mapbox: More modern but adds complexity; Leaflet sufficient
- D3.js: Powerful but steep learning curve; Leaflet easier for standard interactions

## Phase 1: Design Artifacts

**Status**: ✅ COMPLETED

### 1. Data Model
**Output**: [data-model.md](./data-model.md)

**Key Entities**:
- **CountyStatistics** (non-persisted, calculated on-demand):
  - county_name: string
  - school_count: int
  - student_count: int
  - has_data: bool
- **Existing Tables** (read-only access):
  - `schools` table: Requires index on `county_name` column
  - `students` table: JOIN via `school_id` foreign key

**Aggregation Query Pattern**:
```sql
SELECT
    s.county_name,
    COUNT(DISTINCT s.id) as school_count,
    COUNT(st.id) as student_count,
    (COUNT(DISTINCT s.id) > 0) as has_data
FROM schools s
LEFT JOIN students st ON st.school_id = s.id
GROUP BY s.county_name;
```

**Redis Cache Schema**:
- Key Pattern: `county:stats:{countyName}` for individual counties
- Key Pattern: `county:stats:all` for all counties aggregated
- TTL: 900 seconds (15 minutes)

**Critical Index Requirement**:
```sql
CREATE INDEX IF NOT EXISTS idx_county_name ON schools(county_name);
```

### 2. API Contracts
**Output**: [contracts/map-api.yaml](./contracts/map-api.yaml)

**Endpoints Defined**:
1. `GET /api/v1/counties/statistics`
   - Returns all 22 Taiwan county statistics
   - Response: `{data: {counties: [...], total: 22}}`
   - Cache: Redis `county:stats:all`

2. `GET /api/v1/counties/{countyName}/statistics`
   - Returns single county statistics
   - Parameter: `countyName` (e.g., "臺北市")
   - Response: `{data: {county_name, school_count, student_count, has_data}}`
   - Cache: Redis `county:stats:{countyName}`

**Authentication**: All endpoints require `Bearer {JWT}` token in Authorization header

**Error Responses**:
- 400: Invalid county name format
- 401: Unauthorized (invalid/missing token)
- 404: County not found
- 500: Internal server error

### 3. Implementation Guide
**Output**: [quickstart.md](./quickstart.md)

**Step-by-Step Instructions**:
1. **Prerequisites**: Go 1.21+, Node.js 18+, MySQL 8+, Redis 7+
2. **Backend Setup**: Service layer, handler, routes, Redis integration
3. **Frontend Setup**: Leaflet.js integration, React Query hooks, map components
4. **Testing Scenarios**: Map load, county clicks, authentication, caching
5. **Troubleshooting Guide**: Common issues and solutions

**Code Examples Provided**:
- Complete Go service implementation with Redis caching
- Complete Go handler implementation with error handling
- Complete Leaflet.js map initialization
- Complete React Query hooks for county statistics
- Complete TypeScript interfaces and types

## Phase 2: Task Generation

**Status**: ⏳ PENDING (Next Step)

**Command**: `/speckit.tasks`

**Expected Output**: `tasks.md` with dependency-ordered implementation tasks

**Estimated Task Breakdown**:
1. Backend database tasks (index creation, validation)
2. Backend service layer implementation
3. Backend handler and route registration
4. Backend Redis integration
5. Frontend GeoJSON preparation
6. Frontend Leaflet.js setup
7. Frontend map components
8. Frontend React Query integration
9. Frontend authentication integration
10. Testing and verification tasks

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected. This section is intentionally left empty.

## Dependencies

### Feature Dependencies
- **001-user-auth**: REQUIRED (provides JWT authentication middleware, ProtectedRoute component)
- **Database Setup**: REQUIRED (assumes `schools` and `students` tables exist)

### External Dependencies (New)
**Frontend**:
- `leaflet@^1.9.4`: Core map rendering library
- `react-leaflet@^4.2.1`: React bindings for Leaflet (optional but recommended)
- `@types/leaflet@^1.9.8`: TypeScript definitions

**Backend**:
- `github.com/go-redis/redis/v8@^8.11.5`: Redis client for caching

**Data Assets**:
- Taiwan Counties GeoJSON file (22 counties/cities boundary data)

### Existing Dependencies (Reused)
- `@tanstack/react-query`: Already in 001-user-auth
- `axios`: Already in 001-user-auth
- `zod`: Already in 001-user-auth
- `github.com/gin-gonic/gin`: Already in 001-user-auth
- `gorm.io/gorm`: Already in 001-user-auth

## Risk Mitigation

| Risk | Impact | Mitigation Strategy | Status |
|------|--------|---------------------|--------|
| GeoJSON file too large (slow load) | Medium | Simplify polygons, compress file, serve via Vercel CDN | Documented in research.md |
| Taiwan boundary data unavailable | Low | Multiple open sources available (government, OSM, Natural Earth) | Fallback sources identified |
| Leaflet.js SSR issues with Next.js | Medium | Use dynamic import with `ssr: false` for Leaflet components | Pattern documented in quickstart.md |
| Redis unavailable (cache failure) | Low | Graceful degradation: Query database directly, log warning | Implemented in service layer |
| County name inconsistencies | Medium | Normalize county names in database; validate against 22-county whitelist | Validation logic in handler |
| Mobile users accessing desktop-only page | Low | Show clear message: "This feature is optimized for desktop" | UI message in MapView component |
| Schools table missing county_name index | High | Add index in migration or startup check; query will be slow without it | Documented in data-model.md, quickstart.md |

## Success Criteria Validation

Mapping plan deliverables to feature success criteria from spec.md:

- **SC-001** (Page load <3s): Addressed via Redis caching + static GeoJSON serving
- **SC-002** (API response <1s): Addressed via Redis 15-min cache + indexed queries
- **SC-003** (Cache hit ≥80%): Addressed via 15-minute TTL (matches React Query staleTime)
- **SC-004** (Authentication 100%): Addressed via JWT middleware on all endpoints
- **SC-005** (Desktop support ≥1024x768): Addressed via responsive Leaflet.js map
- **SC-006** (Manual testing 100%): Addressed via quickstart.md testing scenarios
- **SC-007** (Zero new tables): Addressed via read-only aggregation on existing tables
- **SC-008** (API versioning): Addressed via `/api/v1` prefix on all endpoints
- **SC-009** (Concurrent users ≥20): Addressed via t3.micro infrastructure (tested in 001-user-auth)
- **SC-010** (Zero critical bugs): Addressed via contract testing + manual scenarios

**Plan Coverage**: ✅ All 10 success criteria mapped to implementation strategy

## Next Steps

1. **Review this plan**: Ensure technical approach aligns with constitution and feature requirements
2. **Run agent context update**: Execute `.specify/scripts/powershell/update-agent-context.ps1 -AgentType claude`
3. **Generate tasks**: Run `/speckit.tasks` to create dependency-ordered implementation tasks
4. **Begin implementation**: Follow task order in tasks.md, referencing quickstart.md for code patterns

**Status**: ✅ Planning phase complete. Ready for `/speckit.tasks` command.
